-- PRISON LIFE AIM ASSIST â€” HEAVILY OPTIMIZED
-- Place in StarterPlayerScripts as LocalScript

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  UPVALUE ALL GLOBALS â€” avoids global env lookup every call
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local mathHuge   = math.huge
local mathMin    = math.min
local mathSqrt   = math.sqrt
local strFmt     = string.format
local toStr      = tostring
local tblConcat  = table.concat
local tickFn     = tick
local taskSpawn  = task.spawn
local taskWait   = task.wait
local taskDelay  = task.delay
local newInst    = Instance.new
local newUDim2   = UDim2.new
local newUDim    = UDim.new
local newCFrame  = CFrame.new
local newColor3  = Color3.fromRGB
local newVector2 = Vector2.new
local ipairsFn   = ipairs
local pairsFn    = pairs

-- Cached Enum values (enum lookup is expensive per-access)
local FONT_BOLD       = Enum.Font.SourceSansBold
local FONT_REG        = Enum.Font.SourceSans
local ALIGN_LEFT      = Enum.TextXAlignment.Left
local ALIGN_TOP       = Enum.TextYAlignment.Top
local AUTO_Y          = Enum.AutomaticSize.Y
local HALIGN_CENTER   = Enum.HorizontalAlignment.Center
local RAY_EXCLUDE     = Enum.RaycastFilterType.Exclude
local BIND_INPUT_PRIO = Enum.RenderPriority.Camera.Value + 1

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  SERVICES â€” cached once, never re-fetched
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local Players    = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace  = game:GetService("Workspace")

local player    = Players.LocalPlayer
local camera    = Workspace.CurrentCamera
local playerGui = player:WaitForChild("PlayerGui", 10)
if not playerGui then error("PlayerGui failed to load") return end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  CONFIG
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local aimAssistEnabled   = false
local wallCheckEnabled   = true
local fovRadius          = 200
local fovRadiusSq        = 200 * 200  -- squared: avoids sqrt in hot path
local minFovRadius       = 100
local maxFovRadius       = 500
local predictionStrength = 0.5
local minPrediction      = 0.0
local maxPrediction      = 2.0
local predStep           = 0.25
local bulletSpeed        = 3000
local invBulletSpeed     = 1 / 3000  -- cached inverse: avoids division per frame
local minBulletSpeed     = 1000
local maxBulletSpeed     = 5000
local bulletSpeedStep    = 500
local smoothness         = 0.25
local minSmoothness      = 0.10
local maxSmoothness      = 0.50
local smoothStep         = 0.05
local reactionTime       = 0.17
local aimPart            = "Head"

-- Selected teams: teamName â†’ true (nil = not selected)
local selectedTeams = {}

local KNOWN_TEAMS = {
    { name = "Inmates",   color = newColor3(255, 100,  80) },
    { name = "Criminals", color = newColor3(255, 165,   0) },
    { name = "Guards",    color = newColor3(100, 160, 255) },
}

local weaponPresets = {
    { name = "M9 (Pistol)",   speed = 2500, smooth = 0.28, pred = 0.4, fov = 180, desc = "Standard Guard pistol\nMedium range, semi-auto" },
    { name = "AK-47",         speed = 3200, smooth = 0.22, pred = 0.6, fov = 200, desc = "High damage rifle\nFull auto, high recoil"       },
    { name = "Remington 870", speed = 1500, smooth = 0.35, pred = 0.2, fov = 250, desc = "Pump shotgun\nClose range, high spread"          },
    { name = "M4A1",          speed = 3500, smooth = 0.20, pred = 0.7, fov = 190, desc = "Guard assault rifle\nFull auto, accurate"        },
    { name = "Sniper",        speed = 4000, smooth = 0.15, pred = 0.8, fov = 150, desc = "Long range rifle\nHigh damage, slow fire rate"   },
    { name = "Taser",         speed = 2000, smooth = 0.30, pred = 0.3, fov = 200, desc = "Non-lethal stun weapon\nShort range projectile"  },
}

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  TARGETED PLAYER CACHE
--  Maintained via events â€” zero rebuild cost per frame.
--  { [player] = BasePart }  (the aim-part reference)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local targetCache   = {}   -- [player] â†’ aimPart BasePart (or false if char not ready)
local targetList    = {}   -- flat array of BasePart refs, rebuilt on changes
local targetListLen = 0

-- Per-character part cache: [player] â†’ { Head, Torso, HumanoidRootPart, Humanoid }
local charPartCache = {}

local function cacheCharParts(p)
    local char = p.Character
    if not char then charPartCache[p] = nil return end
    charPartCache[p] = {
        Head             = char:FindFirstChild("Head"),
        Torso            = char:FindFirstChild("Torso"),
        HumanoidRootPart = char:FindFirstChild("HumanoidRootPart"),
        Humanoid         = char:FindFirstChild("Humanoid"),
    }
end

local function rebuildTargetList()
    local len = 0
    for p, _ in pairsFn(targetCache) do
        if selectedTeams[p.Team and p.Team.Name] then
            local cache = charPartCache[p]
            if cache then
                local part = cache[aimPart] or cache.Head
                local hum  = cache.Humanoid
                if part and hum and hum.Health > 0 then
                    len += 1
                    targetList[len] = part
                end
            end
        end
    end
    -- Wipe stale tail
    for i = len + 1, targetListLen do targetList[i] = nil end
    targetListLen = len
end

local function addToTargetCache(p)
    if p == player then return end
    targetCache[p] = true
    cacheCharParts(p)
    rebuildTargetList()
end

local function removeFromTargetCache(p)
    targetCache[p]   = nil
    charPartCache[p] = nil
    rebuildTargetList()
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  GUI CLEANUP
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
for _, n in ipairsFn({ "PrisonLifeAimGUI","PrisonLifeCyclesGUI","PrisonLifeWeaponsGUI","PrisonLifeTeamsGUI" }) do
    local g = playerGui:FindFirstChild(n)
    if g then g:Destroy() end
end
taskWait(0.05)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  SHARED COLORS  (allocated once, reused everywhere)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local C_ORANGE   = newColor3(255,140,  0)
local C_BLACK    = newColor3(  0,  0,  0)
local C_RED      = newColor3(200, 50, 50)
local C_GREEN    = newColor3( 50,200, 50)
local C_DARK     = newColor3( 40, 40, 45)
local C_DARKER   = newColor3( 30, 30, 30)
local C_CARD     = newColor3( 52, 52, 58)
local C_WHITE    = newColor3(255,255,255)
local C_MUTED    = newColor3(150,150,150)
local C_DISABLED = newColor3(100,100,100)

-- Pre-built UDim2 singletons reused across all buttons
local SZ_FULL_BTN  = newUDim2(1,-20,0,45)
local SZ_FULL_LBAR = newUDim2(1,0,0,40)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  SHARED UI HELPERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function addCorner(inst, r)
    local c = newInst("UICorner")
    c.CornerRadius = newUDim(0, r or 12)
    c.Parent = inst
    return c
end

local function addStroke(inst, color, thickness)
    local s = newInst("UIStroke")
    s.Color     = color or C_ORANGE
    s.Thickness = thickness or 2
    s.Parent    = inst
    return s
end

local function addOrangeTitle(parent, text)
    local t = newInst("TextLabel")
    t.Size             = SZ_FULL_LBAR
    t.BackgroundColor3 = C_ORANGE
    t.BorderSizePixel  = 0
    t.Text             = text
    t.Font             = FONT_BOLD
    t.TextSize         = 16
    t.TextColor3       = C_BLACK
    t.Parent           = parent
    addCorner(t, 12)
    return t
end

local function makeBtn(parent, y, color, text, textColor)
    local b = newInst("TextButton")
    b.Size             = SZ_FULL_BTN
    b.Position         = newUDim2(0, 10, 0, y)
    b.BackgroundColor3 = color
    b.BorderSizePixel  = 0
    b.Text             = text
    b.Font             = FONT_BOLD
    b.TextSize         = 15
    b.TextColor3       = textColor or C_WHITE
    b.AutoButtonColor  = false
    b.Parent           = parent
    addCorner(b, 10)
    return b
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  MAIN GUI
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local mainSG = newInst("ScreenGui")
mainSG.Name         = "PrisonLifeAimGUI"
mainSG.ResetOnSpawn = false
mainSG.Parent       = playerGui

local mainFrame = newInst("Frame")
mainFrame.Size             = newUDim2(0,340,0,480)
mainFrame.Position         = newUDim2(0.02,0,0.08,0)
mainFrame.BackgroundColor3 = C_DARK
mainFrame.BorderSizePixel  = 0
mainFrame.Active           = true
mainFrame.Draggable        = true
mainFrame.Parent           = mainSG
addCorner(mainFrame, 12)
addStroke(mainFrame, C_ORANGE, 2)
addOrangeTitle(mainFrame, "PRISON LIFE AIM ASSIST")

local teamCounterLbl = newInst("TextLabel")
teamCounterLbl.Size             = newUDim2(1,-20,0,28)
teamCounterLbl.Position         = newUDim2(0,10,0,45)
teamCounterLbl.BackgroundColor3 = C_CARD
teamCounterLbl.BorderSizePixel  = 0
teamCounterLbl.Text             = "ğŸ¯ Targeted teams: none"
teamCounterLbl.Font             = FONT_BOLD
teamCounterLbl.TextSize         = 12
teamCounterLbl.TextColor3       = C_ORANGE
teamCounterLbl.Parent           = mainFrame
addCorner(teamCounterLbl, 8)

local aimBtn    = makeBtn(mainFrame,  83, C_RED,                    "Enable Aim Assist")
local wallBtn   = makeBtn(mainFrame, 138, C_GREEN,                  "Wall Check: ON",    C_BLACK)
local teamsBtn  = makeBtn(mainFrame, 193, newColor3(80,130,220),    "Team Targets â–¸")
local weaponBtn = makeBtn(mainFrame, 248, C_ORANGE,                 "Weapon Presets â–¸",  C_BLACK)
local listBtn   = makeBtn(mainFrame, 303, newColor3(150,100,200),   "Show Target List")

local listFrame = newInst("ScrollingFrame")
listFrame.Size                = newUDim2(1,-20,0,130)
listFrame.Position            = newUDim2(0,10,0,358)
listFrame.BackgroundColor3    = C_DARKER
listFrame.BorderSizePixel     = 0
listFrame.Visible             = false
listFrame.ScrollBarThickness  = 6
listFrame.AutomaticCanvasSize = AUTO_Y
listFrame.Parent              = mainFrame
addCorner(listFrame, 10)
local listLayout = newInst("UIListLayout")
listLayout.Padding = newUDim(0, 3)
listLayout.Parent  = listFrame

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  TEAMS GUI
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local teamsSG = newInst("ScreenGui")
teamsSG.Name         = "PrisonLifeTeamsGUI"
teamsSG.ResetOnSpawn = false
teamsSG.Parent       = playerGui

local teamsFrame = newInst("Frame")
teamsFrame.Size             = newUDim2(0,280,0,80)
teamsFrame.Position         = newUDim2(0.02,0,0.55,0)
teamsFrame.BackgroundColor3 = C_DARK
teamsFrame.BorderSizePixel  = 0
teamsFrame.Active           = true
teamsFrame.Draggable        = true
teamsFrame.Visible          = false
teamsFrame.Parent           = teamsSG
addCorner(teamsFrame, 12)
addStroke(teamsFrame, C_ORANGE, 2)
addOrangeTitle(teamsFrame, "ğŸ¯  TEAM TARGETS")

local teamsSub = newInst("TextLabel")
teamsSub.Size               = newUDim2(1,-20,0,18)
teamsSub.Position           = newUDim2(0,10,0,44)
teamsSub.BackgroundTransparency = 1
teamsSub.Text               = "Click teams to toggle targeting  (multi-select)"
teamsSub.Font               = FONT_REG
teamsSub.TextSize           = 11
teamsSub.TextColor3         = C_MUTED
teamsSub.Parent             = teamsFrame

local selAllBtn = newInst("TextButton")
selAllBtn.Size             = newUDim2(0.48,-14,0,30)
selAllBtn.Position         = newUDim2(0,10,0,66)
selAllBtn.BackgroundColor3 = newColor3(60,150,60)
selAllBtn.BorderSizePixel  = 0
selAllBtn.Text             = "âœ” Select All"
selAllBtn.Font             = FONT_BOLD
selAllBtn.TextSize         = 12
selAllBtn.TextColor3       = C_WHITE
selAllBtn.AutoButtonColor  = false
selAllBtn.Parent           = teamsFrame
addCorner(selAllBtn, 8)

local deselAllBtn = newInst("TextButton")
deselAllBtn.Size             = newUDim2(0.48,-14,0,30)
deselAllBtn.Position         = newUDim2(0.5,4,0,66)
deselAllBtn.BackgroundColor3 = newColor3(160,60,60)
deselAllBtn.BorderSizePixel  = 0
deselAllBtn.Text             = "âœ– Clear All"
deselAllBtn.Font             = FONT_BOLD
deselAllBtn.TextSize         = 12
deselAllBtn.TextColor3       = C_WHITE
deselAllBtn.AutoButtonColor  = false
deselAllBtn.Parent           = teamsFrame
addCorner(deselAllBtn, 8)

local teamsScroll = newInst("ScrollingFrame")
teamsScroll.Size                = newUDim2(1,-20,0,0)
teamsScroll.Position            = newUDim2(0,10,0,104)
teamsScroll.BackgroundColor3    = C_DARKER
teamsScroll.BorderSizePixel     = 0
teamsScroll.ScrollBarThickness  = 6
teamsScroll.AutomaticCanvasSize = AUTO_Y
teamsScroll.Parent              = teamsFrame
addCorner(teamsScroll, 10)

local teamsScrollLayout = newInst("UIListLayout")
teamsScrollLayout.Padding              = newUDim(0, 6)
teamsScrollLayout.HorizontalAlignment  = HALIGN_CENTER
teamsScrollLayout.Parent               = teamsScroll

local teamsScrollPad = newInst("UIPadding")
teamsScrollPad.PaddingTop    = newUDim(0, 6)
teamsScrollPad.PaddingBottom = newUDim(0, 6)
teamsScrollPad.Parent        = teamsScroll

-- teamCardRefs[teamName] = { btn, dot, nameLbl, countLbl, checkLbl, teamColor }
local teamCardRefs = {}

-- Pre-built counter string avoids tblConcat inside refreshTeamCounter
local function refreshTeamCounter()
    local names = {}
    local n = 0
    for tname, on in pairsFn(selectedTeams) do
        if on then n += 1; names[n] = tname end
    end
    teamCounterLbl.Text = n == 0
        and "ğŸ¯ Targeted teams: none"
        or  "ğŸ¯ Targeting: " .. tblConcat(names, ", ")
end

local function updateTeamCardCount(tname)
    local ref = teamCardRefs[tname]
    if not ref then return end
    local count = 0
    local allP  = Players:GetPlayers()
    for i = 1, #allP do
        local p = allP[i]
        if p ~= player and p.Team and p.Team.Name == tname then
            count += 1
        end
    end
    ref.countLbl.Text = count .. " online"
end

local function setTeamSelected(tname, on)
    selectedTeams[tname] = on or nil
    local ref = teamCardRefs[tname]
    if ref then
        local tc = ref.teamColor
        if on then
            ref.btn.BackgroundColor3 = newColor3(
                mathMin(tc.R * 255 * 0.55, 255),
                mathMin(tc.G * 255 * 0.55, 255),
                mathMin(tc.B * 255 * 0.55, 255)
            )
            -- Replace stroke efficiently
            for _, c in ipairsFn(ref.btn:GetChildren()) do
                if c:IsA("UIStroke") then c:Destroy() end
            end
            addStroke(ref.btn, tc, 2)
            ref.dot.BackgroundColor3 = tc
            ref.nameLbl.TextColor3   = tc
            ref.checkLbl.Text        = "âœ”"
            ref.checkLbl.TextColor3  = tc
        else
            ref.btn.BackgroundColor3 = C_CARD
            for _, c in ipairsFn(ref.btn:GetChildren()) do
                if c:IsA("UIStroke") then c:Destroy() end
            end
            ref.dot.BackgroundColor3 = C_DISABLED
            ref.nameLbl.TextColor3   = C_MUTED
            ref.checkLbl.Text        = "â—‹"
            ref.checkLbl.TextColor3  = C_MUTED
        end
    end
    rebuildTargetList()
    refreshTeamCounter()
end

local function buildTeamCard(tname, tcolor)
    if teamCardRefs[tname] then return end

    local card = newInst("TextButton")
    card.Size             = newUDim2(1,-12,0,52)
    card.BackgroundColor3 = C_CARD
    card.BorderSizePixel  = 0
    card.Text             = ""
    card.AutoButtonColor  = false
    card.Parent           = teamsScroll
    addCorner(card, 10)

    local dot = newInst("Frame")
    dot.Size             = newUDim2(0,6,0.7,0)
    dot.Position         = newUDim2(0,0,0.15,0)
    dot.BackgroundColor3 = C_DISABLED
    dot.BorderSizePixel  = 0
    dot.Parent           = card
    addCorner(dot, 4)

    local nameLbl = newInst("TextLabel")
    nameLbl.Size               = newUDim2(1,-58,0,26)
    nameLbl.Position           = newUDim2(0,14,0,6)
    nameLbl.BackgroundTransparency = 1
    nameLbl.Text               = tname
    nameLbl.Font               = FONT_BOLD
    nameLbl.TextSize           = 15
    nameLbl.TextColor3         = C_MUTED
    nameLbl.TextXAlignment     = ALIGN_LEFT
    nameLbl.Parent             = card

    local countLbl = newInst("TextLabel")
    countLbl.Size               = newUDim2(1,-58,0,18)
    countLbl.Position           = newUDim2(0,14,0,30)
    countLbl.BackgroundTransparency = 1
    countLbl.Text               = "0 online"
    countLbl.Font               = FONT_REG
    countLbl.TextSize           = 11
    countLbl.TextColor3         = C_MUTED
    countLbl.TextXAlignment     = ALIGN_LEFT
    countLbl.Parent             = card

    local checkLbl = newInst("TextLabel")
    checkLbl.Size               = newUDim2(0,36,0,36)
    checkLbl.Position           = newUDim2(1,-42,0.5,-18)
    checkLbl.BackgroundTransparency = 1
    checkLbl.Text               = "â—‹"
    checkLbl.Font               = FONT_BOLD
    checkLbl.TextSize           = 22
    checkLbl.TextColor3         = C_MUTED
    checkLbl.Parent             = card

    teamCardRefs[tname] = {
        btn = card, dot = dot, nameLbl = nameLbl,
        countLbl = countLbl, checkLbl = checkLbl, teamColor = tcolor,
    }

    card.MouseButton1Click:Connect(function()
        setTeamSelected(tname, not selectedTeams[tname])
    end)

    updateTeamCardCount(tname)
end

local function refreshTeamCards()
    local KT = KNOWN_TEAMS
    for i = 1, #KT do buildTeamCard(KT[i].name, KT[i].color) end
    local scrollH = #KT * 58
    teamsScroll.Size = newUDim2(1,-20,0,scrollH)
    teamsFrame.Size  = newUDim2(0,280,0,104 + scrollH + 12)
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  WEAPON PRESETS PANEL
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local weaponSG = newInst("ScreenGui")
weaponSG.Name         = "PrisonLifeWeaponsGUI"
weaponSG.ResetOnSpawn = false
weaponSG.Parent       = playerGui

local weaponFrame = newInst("ScrollingFrame")
weaponFrame.Size                = newUDim2(0,420,0,650)
weaponFrame.Position            = newUDim2(0,370,0.08,0)
weaponFrame.BackgroundColor3    = C_DARK
weaponFrame.BorderSizePixel     = 0
weaponFrame.Visible             = false
weaponFrame.ScrollBarThickness  = 8
weaponFrame.AutomaticCanvasSize = AUTO_Y
weaponFrame.Active              = true
weaponFrame.Draggable           = true
weaponFrame.Parent              = weaponSG
addCorner(weaponFrame, 12)
addStroke(weaponFrame, C_ORANGE, 2)
addOrangeTitle(weaponFrame, "PRISON LIFE WEAPONS")

local wLayout = newInst("UIListLayout")
wLayout.Padding = newUDim(0, 10)
wLayout.Parent  = weaponFrame

local wPad = newInst("UIPadding")
wPad.PaddingTop    = newUDim(0, 50)
wPad.PaddingLeft   = newUDim(0, 10)
wPad.PaddingRight  = newUDim(0, 10)
wPad.PaddingBottom = newUDim(0, 10)
wPad.Parent        = weaponFrame

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  CYCLES GUI
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local cyclesSG = newInst("ScreenGui")
cyclesSG.Name         = "PrisonLifeCyclesGUI"
cyclesSG.ResetOnSpawn = false
cyclesSG.Parent       = playerGui

local cyclesFrame = newInst("Frame")
cyclesFrame.Size             = newUDim2(0,300,0,410)
cyclesFrame.Position         = newUDim2(0.78,0,0.08,0)
cyclesFrame.BackgroundColor3 = C_DARK
cyclesFrame.BorderSizePixel  = 0
cyclesFrame.Active           = true
cyclesFrame.Draggable        = true
cyclesFrame.Parent           = cyclesSG
addCorner(cyclesFrame, 12)
addStroke(cyclesFrame, C_ORANGE, 2)
addOrangeTitle(cyclesFrame, "âŸ³  CYCLE SETTINGS")

local cycleSub = newInst("TextLabel")
cycleSub.Size               = newUDim2(1,-20,0,20)
cycleSub.Position           = newUDim2(0,10,0,44)
cycleSub.BackgroundTransparency = 1
cycleSub.Text               = "Click â–¶ to cycle each value"
cycleSub.Font               = FONT_REG
cycleSub.TextSize           = 11
cycleSub.TextColor3         = C_MUTED
cycleSub.Parent             = cyclesFrame

local function makeCycleCard(y, accentColor, labelText, startValue)
    local card = newInst("Frame")
    card.Size             = newUDim2(1,-20,0,56)
    card.Position         = newUDim2(0,10,0,y)
    card.BackgroundColor3 = C_CARD
    card.BorderSizePixel  = 0
    card.Parent           = cyclesFrame
    addCorner(card, 10)

    local accent = newInst("Frame")
    accent.Size             = newUDim2(0,4,1,-14)
    accent.Position         = newUDim2(0,0,0,7)
    accent.BackgroundColor3 = accentColor
    accent.BorderSizePixel  = 0
    accent.Parent           = card
    addCorner(accent, 4)

    local lbl = newInst("TextLabel")
    lbl.Size               = newUDim2(1,-62,0,22)
    lbl.Position           = newUDim2(0,12,0,5)
    lbl.BackgroundTransparency = 1
    lbl.Text               = labelText
    lbl.Font               = FONT_BOLD
    lbl.TextSize           = 11
    lbl.TextColor3         = newColor3(190,190,190)
    lbl.TextXAlignment     = ALIGN_LEFT
    lbl.Parent             = card

    local valLbl = newInst("TextLabel")
    valLbl.Size               = newUDim2(1,-62,0,24)
    valLbl.Position           = newUDim2(0,12,0,27)
    valLbl.BackgroundTransparency = 1
    valLbl.Text               = toStr(startValue)
    valLbl.Font               = FONT_BOLD
    valLbl.TextSize           = 16
    valLbl.TextColor3         = accentColor
    valLbl.TextXAlignment     = ALIGN_LEFT
    valLbl.Parent             = card

    local btn = newInst("TextButton")
    btn.Size             = newUDim2(0,42,0,42)
    btn.Position         = newUDim2(1,-50,0.5,-21)
    btn.BackgroundColor3 = accentColor
    btn.BorderSizePixel  = 0
    btn.Text             = "â–¶"
    btn.Font             = FONT_BOLD
    btn.TextSize         = 18
    btn.TextColor3       = C_BLACK
    btn.AutoButtonColor  = false
    btn.Parent           = card
    addCorner(btn, 10)

    -- Hover: brighten by +0.12 on each channel
    local hoverColor = newColor3(
        mathMin((accentColor.R + 0.12) * 255, 255),
        mathMin((accentColor.G + 0.12) * 255, 255),
        mathMin((accentColor.B + 0.12) * 255, 255)
    )
    btn.MouseEnter:Connect(function() btn.BackgroundColor3 = hoverColor end)
    btn.MouseLeave:Connect(function() btn.BackgroundColor3 = accentColor end)

    return btn, valLbl
end

local aimPartCycleBtn, aimPartVal = makeCycleCard( 70, newColor3(100,150,255), "AIM PART",        "Head")
local fovCycleBtn,     fovVal     = makeCycleCard(136, newColor3( 80,100,255), "FIELD OF VIEW",   toStr(fovRadius))
local speedCycleBtn,   speedVal   = makeCycleCard(202, newColor3(255,220,  0), "BULLET SPEED",    toStr(bulletSpeed))
local smoothCycleBtn,  smoothVal  = makeCycleCard(268, newColor3(100,255,150), "SMOOTHNESS",      strFmt("%.2f", smoothness))
local predCycleBtn,    predVal    = makeCycleCard(334, newColor3(255,150, 50), "PREDICTION MULT", strFmt("%.2fx", predictionStrength))

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  TARGET LIST  (UI only, not hot path)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function updateTargetList()
    -- Clear existing labels
    for _, c in ipairsFn(listFrame:GetChildren()) do
        if c:IsA("TextLabel") then c:Destroy() end
    end
    local count = 0
    local allP = Players:GetPlayers()
    for i = 1, #allP do
        local p = allP[i]
        if p ~= player and p.Team and selectedTeams[p.Team.Name] then
            count += 1
            local tname = p.Team.Name
            local e = newInst("TextLabel")
            e.Size             = newUDim2(1,-10,0,25)
            e.BackgroundColor3 = C_CARD
            e.BorderSizePixel  = 0
            e.Text             = strFmt("%d. [%s]  %s", count, tname, p.Name)
            e.TextColor3       = (teamCardRefs[tname] and teamCardRefs[tname].teamColor) or C_WHITE
            e.Font             = FONT_REG
            e.TextSize         = 12
            e.TextXAlignment   = ALIGN_LEFT
            e.Parent           = listFrame
            addCorner(e, 5)
            local ep = newInst("UIPadding")
            ep.PaddingLeft = newUDim(0, 6)
            ep.Parent = e
        end
    end
    if count == 0 then
        local nl = newInst("TextLabel")
        nl.Size               = newUDim2(1,-10,0,30)
        nl.BackgroundTransparency = 1
        nl.Text               = "No targets found"
        nl.TextColor3         = C_MUTED
        nl.Font               = FONT_REG
        nl.TextSize           = 13
        nl.Parent             = listFrame
    end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  WEAPON PRESETS POPULATION
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function populateWeapons()
    for _, c in ipairsFn(weaponFrame:GetChildren()) do
        if c:IsA("Frame") then c:Destroy() end
    end
    local WP = weaponPresets
    for i = 1, #WP do
        local w = WP[i]
        local card = newInst("Frame")
        card.Size             = newUDim2(1,-20,0,120)
        card.BackgroundColor3 = C_CARD
        card.BorderSizePixel  = 0
        card.LayoutOrder      = i
        card.Parent           = weaponFrame
        addCorner(card, 10)
        local st = addStroke(card, C_ORANGE, 1)
        st.Transparency = 0.7

        local function mkL(txt, x, y2, w2, h, size, color, bold)
            local l = newInst("TextLabel")
            l.Size               = newUDim2(0,w2,0,h)
            l.Position           = newUDim2(0,x,0,y2)
            l.BackgroundTransparency = 1
            l.Text               = txt
            l.Font               = bold and FONT_BOLD or FONT_REG
            l.TextSize           = size
            l.TextColor3         = color
            l.TextXAlignment     = ALIGN_LEFT
            l.TextWrapped        = true
            l.Parent             = card
        end
        mkL(w.name, 5, 5,  390, 25, 16, C_ORANGE,                      true)
        mkL(w.desc, 5, 30, 390, 35, 11, newColor3(200,200,200),         false)
        mkL(strFmt("Speed:%d | FOV:%d | Smooth:%.2f", w.speed, w.fov, w.smooth),
            5, 60, 390, 25, 11, newColor3(150,200,255), false)

        local apply = newInst("TextButton")
        apply.Size             = newUDim2(1,-10,0,25)
        apply.Position         = newUDim2(0,5,1,-30)
        apply.BackgroundColor3 = C_ORANGE
        apply.BorderSizePixel  = 0
        apply.Text             = "Apply"
        apply.Font             = FONT_BOLD
        apply.TextSize         = 13
        apply.TextColor3       = C_BLACK
        apply.AutoButtonColor  = false
        apply.Parent           = card
        addCorner(apply, 6)

        -- Capture weapon values to avoid re-indexing w inside callback
        local wSpeed, wSmooth, wPred, wFov = w.speed, w.smooth, w.pred, w.fov
        apply.MouseButton1Click:Connect(function()
            bulletSpeed        = wSpeed
            smoothness         = wSmooth
            predictionStrength = wPred
            fovRadius          = wFov
            fovRadiusSq        = wFov * wFov
            invBulletSpeed     = 1 / wSpeed
            speedVal.Text      = toStr(wSpeed)
            smoothVal.Text     = strFmt("%.2f", wSmooth)
            predVal.Text       = strFmt("%.2fx", wPred)
            fovVal.Text        = toStr(wFov)
            apply.Text             = "Done!"
            apply.BackgroundColor3 = C_GREEN
            taskDelay(1, function()
                apply.Text             = "Apply"
                apply.BackgroundColor3 = C_ORANGE
            end)
        end)
    end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  BUTTON EVENTS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
wallBtn.MouseButton1Click:Connect(function()
    wallCheckEnabled = not wallCheckEnabled
    wallBtn.Text             = wallCheckEnabled and "Wall Check: ON" or "Wall Check: OFF"
    wallBtn.BackgroundColor3 = wallCheckEnabled and C_GREEN or C_RED
    wallBtn.TextColor3       = wallCheckEnabled and C_BLACK or C_WHITE
end)

teamsBtn.MouseButton1Click:Connect(function()
    if not teamsFrame.Visible then
        refreshTeamCards()
        local TCR = teamCardRefs
        for tname in pairsFn(TCR) do updateTeamCardCount(tname) end
    end
    teamsFrame.Visible = not teamsFrame.Visible
end)

weaponBtn.MouseButton1Click:Connect(function()
    weaponFrame.Visible = not weaponFrame.Visible
    if weaponFrame.Visible then populateWeapons() end
end)

listBtn.MouseButton1Click:Connect(function()
    listFrame.Visible = not listFrame.Visible
    if listFrame.Visible then updateTargetList() end
end)

selAllBtn.MouseButton1Click:Connect(function()
    for tname in pairsFn(teamCardRefs) do setTeamSelected(tname, true) end
end)

deselAllBtn.MouseButton1Click:Connect(function()
    for tname in pairsFn(teamCardRefs) do setTeamSelected(tname, false) end
    selectedTeams = {}
    rebuildTargetList()
    refreshTeamCounter()
end)

-- Cycle buttons
local aimParts = { "Head", "Torso", "HumanoidRootPart" }
local aimPartIdx = 1
aimPartCycleBtn.MouseButton1Click:Connect(function()
    aimPartIdx = aimPartIdx % #aimParts + 1
    aimPart = aimParts[aimPartIdx]
    aimPartVal.Text = aimPart
    rebuildTargetList()  -- part refs must be refreshed
end)

fovCycleBtn.MouseButton1Click:Connect(function()
    fovRadius   = fovRadius + 50
    if fovRadius > maxFovRadius then fovRadius = minFovRadius end
    fovRadiusSq = fovRadius * fovRadius
    fovVal.Text = toStr(fovRadius)
end)

speedCycleBtn.MouseButton1Click:Connect(function()
    bulletSpeed    = bulletSpeed + bulletSpeedStep
    if bulletSpeed > maxBulletSpeed then bulletSpeed = minBulletSpeed end
    invBulletSpeed = 1 / bulletSpeed
    speedVal.Text  = toStr(bulletSpeed)
end)

smoothCycleBtn.MouseButton1Click:Connect(function()
    smoothness = smoothness + smoothStep
    if smoothness > maxSmoothness then smoothness = minSmoothness end
    smoothVal.Text = strFmt("%.2f", smoothness)
end)

predCycleBtn.MouseButton1Click:Connect(function()
    predictionStrength = predictionStrength + predStep
    if predictionStrength > maxPrediction then predictionStrength = minPrediction end
    predVal.Text = strFmt("%.2fx", predictionStrength)
end)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  AIM ASSIST LOGIC â€” HOT PATH
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local rayParams = RaycastParams.new()
rayParams.FilterType = RAY_EXCLUDE
local raycastFilter  = { player.Character }
rayParams.FilterDescendantsInstances = raycastFilter

local function hasLineOfSight(targetPart)
    -- Inline early exit â€” no function call overhead
    raycastFilter[1]                     = player.Character
    rayParams.FilterDescendantsInstances = raycastFilter
    local camPos  = camera.CFrame.Position
    local result  = Workspace:Raycast(camPos, targetPart.Position - camPos, rayParams)
    return (not result) or result.Instance:IsDescendantOf(targetPart.Parent)
end

-- Pre-cached viewport halves, updated via signal
local vpHalfX, vpHalfY = 0, 0
local function updateViewport()
    local vs = camera.ViewportSize
    vpHalfX  = vs.X * 0.5
    vpHalfY  = vs.Y * 0.5
end
updateViewport()
camera:GetPropertyChangedSignal("ViewportSize"):Connect(updateViewport)

local loopRunning = false
local lastTarget, acquireTime = nil, 0

-- AIM LOOP â€” bound via BindToRenderStep for guaranteed per-frame execution
-- at highest priority after the camera, no coroutine overhead
local function onRenderStep()
    if not aimAssistEnabled then return end

    -- Cache CFrame once per frame (avoids 2â€“3 extra property lookups below)
    local camCF     = camera.CFrame
    local camPos    = camCF.Position

    local closest, closestDistSq = nil, mathHuge
    local TL = targetList
    local TN = targetListLen

    for i = 1, TN do
        local part = TL[i]
        if part and part.Parent then
            -- Check humanoid alive (cached reference)
            local hum = part.Parent:FindFirstChildOfClass("Humanoid")
            if hum and hum.Health > 0 then
                -- Screen-space FOV check using squared distance (no sqrt)
                local sp, onScreen = camera:WorldToViewportPoint(part.Position)
                if onScreen then
                    local dx = sp.X - vpHalfX
                    local dy = sp.Y - vpHalfY
                    if dx*dx + dy*dy <= fovRadiusSq then
                        local wdx = part.Position.X - camPos.X
                        local wdy = part.Position.Y - camPos.Y
                        local wdz = part.Position.Z - camPos.Z
                        local distSq = wdx*wdx + wdy*wdy + wdz*wdz
                        if distSq < closestDistSq then
                            if not wallCheckEnabled or hasLineOfSight(part) then
                                closestDistSq = distSq
                                closest = part
                            end
                        end
                    end
                end
            end
        end
    end

    if closest ~= lastTarget then
        acquireTime = tickFn()
        lastTarget  = closest
    end

    if closest and (tickFn() - acquireTime >= reactionTime) then
        local pos = closest.Position
        -- Prediction: inline to avoid function call overhead in hot path
        if predictionStrength > 0 then
            local vel = closest.AssemblyLinearVelocity
            if vel.Magnitude >= 1 then
                local dist      = mathSqrt(closestDistSq)
                local totalTime = dist * invBulletSpeed + reactionTime
                pos = pos + vel * (totalTime * predictionStrength)
            end
        end
        camera.CFrame = camCF:Lerp(newCFrame(camPos, pos), smoothness)
    end
end

aimBtn.MouseButton1Click:Connect(function()
    aimAssistEnabled = not aimAssistEnabled
    aimBtn.Text             = aimAssistEnabled and "Disable Aim Assist" or "Enable Aim Assist"
    aimBtn.BackgroundColor3 = aimAssistEnabled and C_GREEN or C_RED
    if aimAssistEnabled then
        lastTarget = nil
        if not loopRunning then
            loopRunning = true
            RunService:BindToRenderStep("AimAssist", BIND_INPUT_PRIO, onRenderStep)
        end
    else
        RunService:UnbindFromRenderStep("AimAssist")
        loopRunning = false
    end
end)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  PLAYER / CHARACTER EVENT HOOKS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function onCharAdded(p)
    -- Re-cache parts when a character spawns/respawns
    p.Character:WaitForChild("HumanoidRootPart", 5)
    cacheCharParts(p)
    rebuildTargetList()
end

local function hookPlayer(p)
    if p == player then return end
    addToTargetCache(p)
    p.CharacterAdded:Connect(function() onCharAdded(p) end)
    p.CharacterRemoving:Connect(function()
        charPartCache[p] = nil
        rebuildTargetList()
    end)
end

-- Hook all current players
local allExisting = Players:GetPlayers()
for i = 1, #allExisting do hookPlayer(allExisting[i]) end

Players.PlayerAdded:Connect(function(p)
    hookPlayer(p)
    taskDelay(0.5, function()
        for tname in pairsFn(teamCardRefs) do updateTeamCardCount(tname) end
        refreshTeamCounter()
    end)
end)

Players.PlayerRemoving:Connect(function(p)
    removeFromTargetCache(p)
    taskDelay(0.1, function()
        for tname in pairsFn(teamCardRefs) do updateTeamCardCount(tname) end
        refreshTeamCounter()
    end)
end)

-- Lightweight background poll â€” only updates visible UI, not aim logic
taskSpawn(function()
    while taskWait(3) do
        if teamsFrame.Visible then
            for tname in pairsFn(teamCardRefs) do updateTeamCardCount(tname) end
        end
        if listFrame.Visible then updateTargetList() end
    end
end)

print("âœ… Prison Life Aim Assist loaded & optimized.")
